<!DOCTYPE html>
<html>
  <head>
    <link rel=stylesheet href="/css/reset.css">
    <link rel=stylesheet href="/css/synseer/main.css">
    <script src="/js/synseer.js"></script>
  </head>
<body>

<div class="content">
  <div class="icing">
    <div class="total_score stats">
      <div class="games_completed"></div>
      <div class="status"></div>
      <div class="correct"></div>
      <div class="incorrect"></div>
      <div class="time"></div>
    </div>
  </div>

  <div class="cake">
    <ul class="available_games">
      <% games.each do |_path, game| %>
        <li class="game">
          <a class="name" href="<%= game.fetch(:path) %>">
            <%= game.fetch(:name) %>
          </a>
          <div class="score" data-id="<%= game.fetch(:id) %>">
             <div class="status"></div>
             <div class="correct"></div>
             <div class="incorrect"></div>
             <div class="time"></div>
          </div>
        </li>
      <% end %>
    </ul>
  </div>
</div>

<script>
  'use strict';
  var Synseer = require('synseer');
  // init/load the data from localstorage
  var appState = {games: []};
  if(localStorage.appState === undefined)
    localStorage.appState = JSON.stringify(appState);
  else
    appState = JSON.parse(localStorage.appState);

  var forEach = Array.prototype.forEach;
  var scores  = document.querySelectorAll('li.game .score');
  forEach.call(scores, function(domScore) {
    // find the current game
    var view = new Synseer.StatsView(domScore);
    var game = undefined;
    for(var i=0; i<appState.games.length; ++i) {
      if(appState.games[i].id === domScore.dataset["id"]) {
        game = appState.games[i];
        break;
      }
    }
    if(game) {
      view.setStatus("Completed");
      view.setNumCorrect(game.numCorrect);
      view.setNumIncorrect(game.numIncorrect);
      view.setDuration(game.duration);
    } else {
      view.setStatus("Unattempted");
      view.setNumCorrect(0);
      view.setNumIncorrect(0);
      view.setDuration(0);
    }
  })

  var numCorrect     = 0;
  var numIncorrect   = 0;
  var duration       = 0;
  var gamesCompleted = 0;
  for(var i=0; i<appState.games.length; ++i) {
    var game = appState.games[i];
    gamesCompleted++;
    numIncorrect += game.numIncorrect;
    numCorrect   += game.numCorrect;
    duration     += game.duration;
  }

  var totalStatsView = new Synseer.StatsView(document.querySelector('.total_score'));
  totalStatsView.setNumCorrect(numCorrect);
  totalStatsView.setNumIncorrect(numIncorrect);
  totalStatsView.setDuration(duration);
  totalStatsView.setGamesCompleted(gamesCompleted);
</script>
</body>
</html>
